<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>恐竜から逃げろ！</title>
  <style>
    body { margin:0; background:#000; font-family:sans-serif; color:white; text-align:center;}
    canvas { display:block; margin:0 auto; background:#8fbc8f;}
    #overlay {
      position:fixed; inset:0;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      background:rgba(0,0,0,0.9); color:white;
      font-size:24px;
      z-index:9999;
    }
    #overlay button { margin:10px; padding:10px 20px; font-size:20px; }
  </style>
</head>
<body>
  <div id="overlay">
    <h1>恐竜から逃げろ！</h1>
    <p>←→で移動、Spaceでジャンプ、↓でしゃがみ</p>
    <div>
      <button onclick="startGame(1)">レベル1</button>
      <button onclick="startGame(2)">レベル2</button>
      <button onclick="startGame(3)">レベル3</button>
    </div>
  </div>
  <canvas id="game" width="600" height="400"></canvas>

  <script>
    const canvas=document.getElementById("game");
    const ctx=canvas.getContext("2d");
    const VIEW_W=canvas.width, VIEW_H=canvas.height;
    const WORLD_W=VIEW_W*12;
    const GROUND_Y=VIEW_H-34;
    const GRAVITY=0.5;

    const player={x:200,y:GROUND_Y,size:40,speed:4.2,emoji:"🏃‍♀️‍➡️",vy:0,onGround:true,stunnedUntil:0,crouching:false,speedBoostUntil:0};
    const dinoBaseSpeed={1:2.2,2:3.6,3:5.0};
    const dino={x:-180,y:GROUND_Y+20,size:200,speed:2.2,emoji:"🦖"};
    const goal={x:WORLD_W-220,y:GROUND_Y,size:160,emoji:"🏠"};
    const clearSound=new Audio("audio/clear.mp3");

    let score=0;
    let dinoEscaping=false;
    let roarTimer=0;

    const cacti=[];for(let x=700;x<WORLD_W-400;x+=800+Math.random()*200){cacti.push({x,y:GROUND_Y,size:60,emoji:"🌵"});}
    const logs=[];for(let x=1600;x<WORLD_W-500;x+=1800+Math.random()*400){logs.push({x,y:GROUND_Y,size:70,emoji:"🪵"});}
    const rocks=[];for(let x=1000;x<WORLD_W-300;x+=1000+Math.random()*300){rocks.push({x,y:GROUND_Y,size:50,emoji:"🪨"});}
    const trampolines=[];for(let x=1400;x<WORLD_W-600;x+=1400+Math.random()*300){trampolines.push({x,y:GROUND_Y,size:60,emoji:"↗️"});}
    const coins=[];for(let x=500;x<WORLD_W-300;x+=600){coins.push({x,y:GROUND_Y-80,size:30,emoji:"🪙",taken:false});}
    const fragilePlatforms=[{x:2200,y:GROUND_Y-100,size:120,falling:false,vy:0}];
    const windZones=[{x:3000,width:500,strength:-1.5}];
    const movingPlatforms=[{x:4000,y:GROUND_Y-120,size:100,dir:1}];
    const boosts=[{x:2800,y:GROUND_Y,size:50,emoji:"⚡"}];
    let bombs=[], meteors=[];

    let camX=0, started=false, level=1, state="title";const keys={};
    let fireworks=[];

    function spawnFirework(cx,cy){const color=`hsl(${Math.random()*360},100%,60%)`;for(let i=0;i<30;i++){const a=Math.random()*Math.PI*2;const s=Math.random()*3+2;fireworks.push({x:cx,y:cy,vx:Math.cos(a)*s,vy:Math.sin(a)*s,color,life:60});}} 
    function updateFireworks(){fireworks.forEach(f=>{f.x+=f.vx;f.y+=f.vy;f.vy+=0.05;f.life--;});fireworks=fireworks.filter(f=>f.life>0);}
    function drawFireworks(){fireworks.forEach(f=>{ctx.fillStyle=f.color;ctx.fillRect(f.x,f.y,3,3);});}

    const bombImg=new Image();bombImg.src="images/test.png";
    function spawnBomb(){const x=camX+Math.random()*VIEW_W;bombs.push({x:x,y:-40,vy:2,size:60});}

    // 隕石生成（常に左斜め落下）
    function spawnMeteor(){
      const x=camX+Math.random()*VIEW_W;
      const vx=-2;
      meteors.push({x:x,y:-60,vx:vx,vy:3,size:50});
    }

    // 隕石描画（上下反転）
    function drawMeteor(m){
      ctx.save();
      ctx.translate(m.x,m.y);
      ctx.scale(1,-1);
      ctx.font=m.size+"px serif";
      ctx.fillText("☄️",0,0);
      ctx.restore();
    }

    document.addEventListener("keydown",e=>{keys[e.key]=true;if(e.code==="Space"&&player.onGround&&started){player.vy=-11.5;player.onGround=false;}if(e.key==="ArrowDown")player.crouching=true;});
    document.addEventListener("keyup",e=>{keys[e.key]=false;if(e.key==="ArrowDown")player.crouching=false;});

    function startGame(lv){
      document.getElementById("overlay").style.display="none";
      level=lv;dino.speed=dinoBaseSpeed[lv];state="game";started=true;
      player.x=200;player.y=GROUND_Y;player.vy=0;player.stunnedUntil=0;
      dino.x=-180;dino.y=GROUND_Y+20;
      bombs=[];meteors=[];fireworks=[];
      score=0;dinoEscaping=false;roarTimer=0;
      coins.forEach(c=>c.taken=false);
      fragilePlatforms.forEach(p=>{p.falling=false;p.y=GROUND_Y-100;p.vy=0;});
    }

    let flashAlpha=0, clearTextAlpha=0;

    function update(){
      if(state==="gameclear"){
        updateFireworks();
        flashAlpha*=0.9;clearTextAlpha=Math.min(1,clearTextAlpha+0.02);
        if(dinoEscaping){dino.x-=8;}
        if(roarTimer>0)roarTimer--;
        return;
      }
      if(state!=="game")return;

      const prevX=player.x, prevY=player.y;
      let move=0;if(keys["ArrowLeft"])move-=1;if(keys["ArrowRight"])move+=1;

      let speedMul=1;
      if(performance.now()<player.stunnedUntil) speedMul=0.4;
      if(performance.now()<player.speedBoostUntil) speedMul=1.8;

      player.x+=move*player.speed*speedMul;
      player.vy+=GRAVITY;player.y+=player.vy;
      if(player.y>=GROUND_Y){player.y=GROUND_Y;player.vy=0;player.onGround=true;}else player.onGround=false;
      player.x=Math.max(0,Math.min(WORLD_W-player.size,player.x));

      for(const w of windZones){if(player.x>w.x && player.x<w.x+w.width){player.x+=w.strength;}}

      if(Math.random()<0.01)spawnBomb();
      for(const b of bombs){b.vy+=0.2;b.y+=b.vy;if(Math.abs(player.x-b.x)<40&&Math.abs(player.y-b.y)<40){player.stunnedUntil=performance.now()+2000;b.hit=true;}if(b.y>GROUND_Y)b.hit=true;}
      bombs=bombs.filter(b=>!b.hit);

      if(Math.random()<0.005)spawnMeteor();
      for(const m of meteors){m.x+=m.vx;m.y+=m.vy;if(Math.abs(player.x-m.x)<40&&Math.abs(player.y-m.y)<40){player.stunnedUntil=performance.now()+2000;m.hit=true;}if(m.y>GROUND_Y)m.hit=true;}
      meteors=meteors.filter(m=>!m.hit);

      for(const c of coins){if(!c.taken&&Math.abs(player.x-c.x)<30&&Math.abs(player.y-c.y)<40){c.taken=true;score++;}}

      for(const p of fragilePlatforms){if(!p.falling && Math.abs(player.x-p.x)<p.size/2 && Math.abs(player.y-p.y)<40){p.falling=true;}if(p.falling){p.vy+=0.3;p.y+=p.vy;}}

      for(const mp of movingPlatforms){
        mp.y+=mp.dir*1.2;
        if(mp.y<GROUND_Y-160||mp.y>GROUND_Y-80) mp.dir*=-1;
        if(Math.abs(player.x-mp.x)<mp.size/2 && Math.abs(player.y-mp.y)<40){
          player.y=mp.y-40;player.vy=0;player.onGround=true;
        }
      }

      for(const b of boosts){if(Math.abs(player.x-b.x)<40 && player.y>=GROUND_Y-5){player.speedBoostUntil=performance.now()+3000;}}

      function collideBlock(obj,size=40){if(Math.abs(player.x-obj.x)<size&&player.y>=GROUND_Y-5){player.x=prevX;player.y=prevY;}}
      for(const c of cacti)collideBlock(c,40);
      for(const log of logs)collideBlock(log,50);
      for(const r of rocks)collideBlock(r,40);

      for(const t of trampolines){if(Math.abs(player.x-t.x)<40&&player.y>=GROUND_Y-5){player.vy=-22.5;player.onGround=false;}}

      // 恐竜追跡と接触判定
      if(dino.x<player.x-150){dino.x+=dino.speed;}
      if(dino.x + dino.size/2 >= player.x - player.size/2){
        state="gameover";
        return; // 即終了
      }

      if(player.x>goal.x+50){
        state="gameclear";
        clearSound.play();
        flashAlpha=1; clearTextAlpha=0;
        let t=setInterval(()=>{spawnFirework(goal.x-camX+100,goal.y-100);},150);
        setTimeout(()=>clearInterval(t),5000);
        dinoEscaping=true;roarTimer=60;
      }

      camX=Math.max(0,Math.min(player.x-VIEW_W/2,WORLD_W-VIEW_W));
    }

    function drawEmoji(e,x,y,s,flip=false){ctx.save();ctx.font=s+"px serif";ctx.textBaseline="bottom";if(flip){ctx.translate(x+s,y);ctx.scale(-1,1);}else{ctx.translate(x,y);}ctx.fillText(e,0,0);ctx.restore();}
    function drawBackground(){ctx.fillStyle="#87ceeb";ctx.fillRect(0,0,VIEW_W,VIEW_H);} 

    function draw(){
      ctx.clearRect(0,0,VIEW_W,VIEW_H);drawBackground();ctx.save();ctx.translate(-camX,0);
      ctx.fillStyle="#7fbf7f";ctx.fillRect(0,GROUND_Y,WORLD_W,VIEW_H-GROUND_Y);
      for(const c of cacti)drawEmoji(c.emoji,c.x,c.y,c.size);
      for(const log of logs)drawEmoji(log.emoji,log.x,log.y,log.size);
      for(const r of rocks)drawEmoji(r.emoji,r.x,r.y,r.size);
      for(const t of trampolines)drawEmoji(t.emoji,t.x,t.y,t.size);
      for(const b of bombs)ctx.drawImage(bombImg,b.x,b.y,b.size,b.size);
      for(const m of meteors)drawMeteor(m);
      for(const c of coins)if(!c.taken)drawEmoji(c.emoji,c.x,c.y,c.size);
      for(const p of fragilePlatforms)if(!p.falling)ctx.fillStyle="brown",ctx.fillRect(p.x-p.size/2,p.y-10,p.size,10);
      for(const mp of movingPlatforms)ctx.fillStyle="gray",ctx.fillRect(mp.x-mp.size/2,mp.y-10,mp.size,10);
      for(const b of boosts)drawEmoji(b.emoji,b.x,b.y,b.size);
      drawEmoji(player.emoji,player.x,player.y,player.size);

      if(!dinoEscaping){
        drawEmoji(dino.emoji,dino.x,dino.y,dino.size,true);
      }else{
        drawEmoji(dino.emoji,dino.x,dino.y,dino.size,false);
        if(roarTimer>0){
          ctx.fillStyle="red";
          ctx.font="32px sans-serif";
          ctx.fillText("ガオー！",dino.x-camX,dino.y-100);
        }
      }

      drawEmoji(goal.emoji,goal.x,goal.y,goal.size);
      ctx.restore();

      ctx.fillStyle="white";ctx.font="20px sans-serif";ctx.textAlign="left";
      ctx.fillText("Score: "+score,20,30);

      if(state==="gameclear"){
        drawFireworks();
        if(flashAlpha>0){ctx.fillStyle=`rgba(255,255,255,${flashAlpha})`;ctx.fillRect(0,0,VIEW_W,VIEW_H);}
        ctx.fillStyle=`rgba(255,215,0,${clearTextAlpha})`;ctx.font="48px sans-serif";ctx.textAlign="center";
        ctx.fillText("🎉 GAME CLEAR!! 🎉",VIEW_W/2,VIEW_H/2);
        ctx.fillText(`Score: ${score}`,VIEW_W/2,VIEW_H/2+60);
      }
      if(state==="gameover"){ctx.fillStyle="red";ctx.font="48px sans-serif";ctx.textAlign="center";ctx.fillText("GAME OVER",VIEW_W/2,VIEW_H/2);}
    }

    function loop(){update();draw();requestAnimationFrame(loop);}loop();
  </script>
</body>
</html>
